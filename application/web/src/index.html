<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <title>Hello, world!</title>
  </head>
  <body class="">
  	<div class="container">
		<h3>
			Capability Explorer
			<small class="text-muted">Run all supported commands</small>
		</h3>  

		<div class="row">
			<nav class="navbar-expand-lg navbar-light bg-light" aria-label="breadcrumb">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="#">Home</a></li>
					<li class="breadcrumb-item"><a href="#">Library</a></li>
					<li class="breadcrumb-item active" aria-current="page">Data</li>
				</ol>
			</nav>
		</div>

		<div class="row mt-3">
			<div class="input-group mb-3">
				<div class="input-group-prepend">
				  <span class="input-group-text">List Capability</span>
				</div>
				<input id="capability-list-id" type="text" class="form-control">
				<button id="capability-list" class="btn btn-primary" type="button">List</button>
			</div>
		</div>
		
		<div class="row mt-3">
			<div class="col-3 mt-1">
				<select btn-block id="api-url" class="form-select">
				</select>

				<button id="capability-run" class="btn w-100 btn-primary mt-1" type="button">Run</button>
				<button id="capability-update-displayFields" class="btn w-100 btn-primary mt-1" type="button">Update Display Fields</button>
				<button id="show-displayFields" class="btn w-100 btn-primary mt-1" type="button">Show All Display Fields</button>
			</div>

			<div id="api-param-area" class="col-9">

			</div>

		</div>

		<div class="row mt-3">
			<div id="results" class="row">

			</div>

			<ul id="dataList"></ul>
			<div class="templates">
			  <div id="listItem">
				<div class="row1">
				  <div class="title"></div>
				  <div class="amount"></div>
				</div>
				<div class="row2"><div class="description"></div></div>
			  </div>
			</div>
		</div>
	</div>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	
	<script type="text/javascript">
		var JBSCount = 0; // JSON Button Set Counter
		var domain = "http://localhost:8008";
		var displayFields = [];
		var showAllDisplayFields = false;
		var buttonDupes = [];
		var capabilities = [];

		$("#show-displayFields").on("click", function(e)
		{
			if (showAllDisplayFields) {
				showAllDisplayFields = false;
			} else {
				showAllDisplayFields = true;
			}
		});

		$("#capability-update-displayFields").on("click", function(e)
		{
			console.log(displayFields);
			
			$('.displayFieldGroup').each(function() 
			{
				var displayItem = $(this).attr("data-row");
				var isChecked = $(this).children(".displayFieldHidden").is(":checked");

				if (isChecked && !displayFields.includes(displayItem))
				{
					console.log("Hiding displayField: " + displayItem);
					displayFields.push(displayItem);
				}
				else if (!isChecked && displayFields.includes(displayItem))
				{
					console.log("Unhiding displayField: " + displayItem);
					displayFields = displayFields.filter(v => v !== displayItem); 
				}
			});

			$.ajax({
				url: domain + "/capability/update",
				type: "get",
				data: { 
					id: $("#api-url").find(":selected").val(),
					displayFields: JSON.stringify(displayFields),
				},
				success: function(response) {
					console.log(response);
					loadAPIParamArea($("#api-url").find(":selected").val());
				},
				error: function(xhr) {
					console.log(xhr);
				}
			});
		});

		$("#capability-list").on("click", function(e)
		{
			$.ajax({
				url: domain + "/capability/get",
				type: "get",
				data: { 
					id: $("#capability-list-id").val(),
				},
				success: function(response) {
					console.log(response);
					
					oliversGlob = JSON.parse(response);
					$("#results").html(jsonToList(JSON.parse(response)));

				},
				error: function(xhr) {
					console.log(xhr);
				}
			});
		});

		$("#capability-run").on("click", function(e)
		{
			var selectedCapability = {};

			for (const capability of capabilities) 
			{
				if (capability.ID == $("#api-url").find(":selected").val())
				{
					selectedCapability = capability;
					continue;
				}
			}

			$('.api-param-val').each(function() {
				paramID = $(this).attr("data-param-id");
				paramVal = $(this).val();

				selectedCapability.Command.Params[paramID].Value = paramVal;
			});

			$.ajax({
				url: domain + "/capability/run",
				type: "get",
				data: { 
					capability: JSON.stringify(selectedCapability),
				},
				success: function(response) {
					console.log(response);
					
					$("#results").html(jsonToDisplay(JSON.parse(response)));

				},
				error: function(xhr) {
					console.log(xhr);
				}
			});
		});

		var count = 0;
		function jsonToDisplay(jsonDat) 
		{
			console.log(jsonDat.toString() + " A: " + (jsonDat instanceof Array) + " OO: " + (jsonDat.toString().startsWith("[object Object]")));

			if (jsonDat instanceof Array)
			{
				var html = "";

				for (var key in jsonDat) 
				{
					html += "<div class='row'>";
					html += "<h2>" + key + "</h2>";
					html += "</div>";
				}

				return html;
			}
			else if (jsonDat.toString().startsWith("[object Object]"))
			{
				var html = "<div class='accordion'>";

				for (var key in jsonDat) 
				{
					html += `
					<div class="accordion" id="acc-`  `">
						<div class="accordion-item">
							<h2 class="accordion-header" id="headingOne">
								<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
									Accordion Item #1
								</button>
							</h2>
							<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
							<div class="accordion-body">
								<strong>This is the first item's accordion body.</strong> It is shown by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
							</div>
							</div>
						</div>`;
				}

				html += "</div>";

				return html;
			}
			// else if (jsonDat instanceof Array)
			// {
			// 	var arrayHtml = "<div class='row offset-" + count++ +"'>";

			// 	for (var key in Object.keys(jsonDat)) 
			// 	{
			// 		arrayHtml += "<span class='badge bg-primary'>Index: " + key + "</span>";
			// 		arrayHtml += jsonToDisplay(jsonDat[key]);
			// 	}

			// 	arrayHtml += "</div>";
			// 	return arrayHtml;
			// }
			// else if (jsonDat instanceof Object && !(jsonDat instanceof String)) //Array Object
			// {
			// 	var objectHtml = "<div class='row'>";

			// 	for (var key in jsonDat) 
			// 	{
			// 		objectHtml += "<div class='row offset-'" + count++ + ">";

			// 		if (jsonDat[key] instanceof Array) // Child is an array
			// 		{
			// 			objectHtml += jsonToDisplay(jsonDat[key]);
			// 		}
			// 		else // Child is an object or string
			// 		{
			// 			objectHtml += "<span class='badge bg-warning col-1'>" + key + "</span>";
			// 			objectHtml += jsonToDisplay(jsonDat[key]);
			// 		}

			// 		objectHtml += "</div>";
			// 	}

				

			// 	return objectHtml;
			// }
			// else // String
			// {
			// 	return "<span class='col-1'>" + jsonDat + "</span>";
			// }
		}

		function jsonToList(obj) 
		{
			if (obj instanceof Array) {
				var ol = document.createElement('ol');
				for (var child in obj) {
					var li = document.createElement('li');
					li.appendChild(jsonToList(obj[child]));
					ol.appendChild(li);
				}
				return ol;
			}
			else if (obj instanceof Object && !(obj instanceof String)) {
				var ul = document.createElement('div');
				ul.classList.add("list-group");

				for (var child in obj) 
				{
					var li = document.createElement('div');
					li.classList.add("list-group-item");
					li.classList.add("display-row")
					li.appendChild(document.createTextNode(child + ": "));
					li.setAttribute("data-row-name", child);
					li.appendChild(jsonToList(obj[child]));

					if (displayFields.includes(child)) 
					{
						if (!buttonDupes.includes(child))
						{
							li.innerHTML += `
							<div class='btn-group float-end displayFieldGroup' data-row='` + child + `' role='group'>
							<input type='radio' class='btn-check' name='JBS-` + JBSCount + `' id='JBS-SHOW-` + JBSCount + `' autocomplete='off'>
							<label class='btn btn-outline-primary' for='JBS-SHOW-` + JBSCount + `'>Show</label>

							<input type='radio' class='btn-check displayFieldHidden' name='JBS-` + JBSCount + `' id='JBS-HIDE-` + JBSCount + `' autocomplete='off' checked>
							<label data-bs-toggle='tooltip' data-bs-placement='top' title='Hide: ` + child +`' class='btn btn-outline-primary' for='JBS-HIDE-` + JBSCount + `'>Hide</label>
							</div>`;
						}
						else
						{
							buttonDupes.push(child);
						}

						if (showAllDisplayFields == false) 
						{
							li.classList.add("collapse");
						}
					}
					else
					{
						if (!buttonDupes.includes(child))
						{
							li.innerHTML += `
							<div class='btn-group float-end displayFieldGroup' data-row='` + child + `' role='group'>
							<input type='radio' class='btn-check' name='JBS-` + JBSCount + `' id='JBS-SHOW-` + JBSCount + `' autocomplete='off' checked>
							<label class='btn btn-outline-primary' for='JBS-SHOW-` + JBSCount + `'>Show</label>

							<input type='radio' class='btn-check displayFieldHidden' name='JBS-` + JBSCount + `' id='JBS-HIDE-` + JBSCount + `' autocomplete='off'>
							<label data-bs-toggle='tooltip' data-bs-placement='top' title='Hide: ` + child +`' class='btn btn-outline-primary' for='JBS-HIDE-` + JBSCount + `'>Hide</label>
							</div>`;
						}
						else
						{
							buttonDupes.push(child);
						}
					}

					ul.appendChild(li);

					JBSCount++;
				}
				return ul;
			}
			else {
				return document.createTextNode(obj);
			}

			buttonDupes = [];
		}

		function loadAPIParamArea(id)
		{
			$.getJSON(domain + "/capability/get?id=" + id, (data) => 
			{
				$('#api-param-area').empty();

				for (var i = 0; i < data.Command.Params.length; i++)
				{
					if (data.Command.Params[i].MetaType == 7) // Disabled area
					{
						$('#api-param-area').append(`
							<h6>` + data.Command.Params[i].MetaInfo + `</h6>
							<div class='input-group mt-1'>
								<span style='min-width:50px;' class='input-group-text'>` + data.Command.Params[i].Flag + `</span>
								<input readonly class='form-control api-param-val' data-param-id='` + i + `' placeholder='` + data.Command.Params[i].MetaDefault + `'>
							</div>`);
					}
					else
					{
						$('#api-param-area').append(`
							<h6>` + data.Command.Params[i].MetaInfo + `</h6>
							<div disable class='input-group mt-1'>
								<span style='min-width:50px;' class='input-group-text'>` + data.Command.Params[i].Flag + `</span>
								<input class='form-control api-param-val' data-param-id='` + i + `' placeholder='` + data.Command.Params[i].MetaDefault + `'>
							</div>`);
					}
				}

				displayFields = [];
				displayFields = JSON.parse(data.DisplayFields);
				console.log("Display Fields: " + displayFields);
			});
		}

		$(document).ready(function()
		{
			$.getJSON(domain + "/capability/get", (data) => 
			{
				for (var i = 0; i < data.length; i++)
				{
					capabilities.push(data[i]);
					$('#api-url').append('<option value="'+ data[i].ID +'">'+ data[i].Name +' (' + data[i].Type + ')</option>');
				}

				loadAPIParamArea(data[0].ID);
			});
		});

		$(document).on('change','#api-url',function()
		{
			loadAPIParamArea($(this).find(":selected").val());
		});
	</script>
</body>
</html>